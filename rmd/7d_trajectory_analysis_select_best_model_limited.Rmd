---
title: "2d_trajectory_analysis_select_best_model"
author: "Brit Henderson"
date: "4/8/2022"
output: html_document
---

```{r directories}
readdatdir <- "/data/share/xproject/Training/Practice/henderson/Dissertation/rda"
rdadir <- "/data/share/xproject/Training/Practice/henderson/Dissertation/rda"

```

# packages
```{r message=FALSE, warning=FALSE, include=FALSE}
# Loads crimCV into the interpreter
library(crimCV)
library(tidyverse)
library(Hmisc)
library(GGally)
library(cowplot)
library(reshape2)

```

# Source Functions
```{r}
knitr::purl("rmd/0a_functions.Rmd")
source("rmd/0a_functions.R")
```


# Combine AIC results from all loops
```{r}
aic1a <- readRDS("/data/share/xproject/Training/Practice/henderson/Dissertation/rda/Intermediate/aic1.rds")
aic2a <- readRDS("/data/share/xproject/Training/Practice/henderson/Dissertation/rda/Intermediate/aic2.rds")
aic3a <- readRDS("/data/share/xproject/Training/Practice/henderson/Dissertation/rda/Intermediate/aic3.rds")
aic4a <- readRDS("/data/share/xproject/Training/Practice/henderson/Dissertation/rda/Intermediate/aic4.rds")


aic2b <- filter(aic2a, cluster==4)
aic3b <- filter(aic3a, cluster==5)
aic4b <- filter(aic4a, cluster==6)

aic.all <- rbind(aic1a,aic2b,aic3b,aic4b)

```


# Combine BIC results from all loops
```{r}
bic1a <- readRDS("/data/share/xproject/Training/Practice/henderson/Dissertation/rda/Intermediate/bic1.rds")
bic2a <- readRDS("/data/share/xproject/Training/Practice/henderson/Dissertation/rda/Intermediate/bic2.rds")
bic3a <- readRDS("/data/share/xproject/Training/Practice/henderson/Dissertation/rda/Intermediate/bic3.rds")
bic4a <- readRDS("/data/share/xproject/Training/Practice/henderson/Dissertation/rda/Intermediate/bic4.rds")


bic2b <- filter(bic2a, cluster==4)
bic3b <- filter(bic3a, cluster==5)
bic4b <- filter(bic4a, cluster==6)

bic.all <- rbind(bic1a,bic2b,bic3b,bic4b)

```


# Plot Results from all models
```{r}  
  AIC.gbtm.plot = ggplot(aic.all) + 
    geom_line(aes(x=x,y=value,col=as.factor(cluster))) +
    #geom_point(aes(x=x,y=value,col=as.factor(cluster))) +
    geom_text(aes(x=x,y=value,col=as.factor(cluster),label=cluster),size=5) + 
    scale_x_continuous(breaks = c(1,2,3)) +
     theme(axis.text = element_text(size=12), axis.title = element_text(size=14)) +
   xlab("Polynomial Degrees") +
    ylab("AIC")
  
  BIC.gbtm.plot = ggplot(bic.all) + 
    geom_line(aes(x=x,y=value,col=as.factor(cluster))) +
    # geom_point(aes(x=x,y=value,col=as.factor(cluster))) +
    geom_text(aes(x=x,y=value,col=as.factor(cluster),label=cluster),size=5) +
     scale_x_continuous(breaks = c(1,2,3)) +
    theme(axis.text = element_text(size=12), axis.title = element_text(size=14)) +
   xlab("Polynomial Degrees") +
    ylab("BIC")
  
 # cv.error.gbtm.plot = ggplot(points.for.cv.plot) + 
 #   geom_line(aes(x=x,y=value,col=as.factor(cluster))) +
#    geom_text(aes(x=x,y=value,col=as.factor(cluster),label=cluster),size=5) +
    #geom_point(aes(x=x,y=value,col=as.factor(cluster))) +
 #   xlab("Polynomial")  +
#    ylab("LOOCV Absolute error") 
  
  plot.legend = get_legend(AIC.gbtm.plot + theme(legend.position = "none"))
  
  model.eval.plot = 
    plot_grid(
      plot_grid(#cv.error.gbtm.plot + theme(legend.position = "none"),
                              BIC.gbtm.plot + theme(legend.position = "none"),
                              AIC.gbtm.plot + theme(legend.position = "none"),
                              ncol=2),
      plot.legend,nrow = 2,rel_heights = c(10,1))
  
  # plot model evaluation
  model.eval.plot
  
```

## Set the parameters for your model of choice
```{r}
  
#re-run loop that includes chosen model
#loop for n.cluster = c(1,1,1,1,1,6) and p.poly = c(1,2,3)

# GBTM CLUSTERING: crimCV
## set the grid of models to evaluate
  # Set: 
    n.cluster = c(1,1,1,1,1,6) # 1.which k's to evaluate, 
    p.poly = c(3) # 2. which p's to evaluate, 
    rcv = F # 3. do you want to run cross validation? T/F

## model evaluation
  
  # Run all models
    cv.eval.list = list()
    index = 0
    for(k in n.cluster)
    {
      sub.index = 0
      index = index + 1
          cv.eval.list[[index]] = list()
          names(cv.eval.list)[k] = paste("Groups",k,sep="_")
          for(p in p.poly)
            {
            print(cat("\n Running models for", n.cluster[k], "Groups, and",p.poly[p],"polynomials..."))
            cat("\n running k=",k,"poly=",p," \n")
            sub.index = sub.index + 1
            temp = crimCV(df,
                          ng = k,
                          dpolyp = p,
                          rcv = rcv,     
                          model = "ZIP"
                          )
        
            cv.eval.list[[index]][[sub.index]] = temp
        
            names(cv.eval.list[[index]])[sub.index] = paste("polynomial",p,sep="_")
            }
    }
    
## retrieve model evaluation results  
  
  # retrieve AIC, BIC and CV error for each of the models
  points.for.AIC.plot = points.for.BIC.plot = points.for.cv.plot = data.frame(x=NA,value=NA,cluster=NA)
  for(c in 1:length(cv.eval.list)){
    for(p in 1:length(cv.eval.list[[c]])){
      
  
      tryCatch({
          cv = ifelse(!is.null(cv.eval.list[[c]][[p]]$cv),cv.eval.list[[c]][[p]]$cv,NA)
          points.for.cv.plot = rbind(points.for.cv.plot,
                                     data.frame(x=p,value=cv ,cluster=c))
      }, error =function(e){})
      
      
      tryCatch({
          aic = ifelse(!is.null(cv.eval.list[[c]][[p]]$AIC),cv.eval.list[[c]][[p]]$AIC,NA)
          points.for.AIC.plot = rbind(points.for.AIC.plot,
                                      data.frame(x=p,value=aic,cluster=c))
      }, error =function(e){})
      
          tryCatch({
          bic = ifelse(!is.null(cv.eval.list[[c]][[p]]$BIC),cv.eval.list[[c]][[p]]$BIC,NA)
          points.for.BIC.plot = rbind(points.for.BIC.plot,
                                      data.frame(x=p,value=bic,cluster=c))
          }, error =function(e){})
      
    }}
  
  points.for.AIC.plot = points.for.AIC.plot[-1,]  
  points.for.BIC.plot = points.for.BIC.plot[-1,] 
  points.for.cv.plot = points.for.cv.plot[-1,]



# Select k and p 
  k.set = 6
  p.set = 3
  
  
  
  # plot details
  y.axis.label = "Young Adult Arrests per County Year"
  x.axis.label = "Year"
  plot.title = "Young Adult Arrest Rate by Year"


## Retrieve data from your model of choice

  # retrieve the final model
  
    # select model
    ind.k = which(grepl(k.set,names(cv.eval.list)))
    ind.p = which(grepl(p.set,names(cv.eval.list[[ind.k]])))
    # retrieve participants membership
    gbtm.members = data.frame(ID =  rownames(df),
                                   cluster = apply(summary(cv.eval.list[[ind.k]][[ind.p]]),
                                                   1,
                                                   function(x)which(x ==max(x))))
    
   
  
#save results
#     saveRDS(gbtm.members,"rda/Intermediate/gbtm.members.rds")
   # gbtm.members <- readRDS("/data/share/xproject/Training/Practice/henderson/Dissertation/rda/Intermediate/gbtm.members.rds")

members.per.cluster = data.frame(table(gbtm.members$cluster))

modelled.list = plot(cv.eval.list[[ind.k]][[ind.p]],size=1,plot=F)

modelled.list$time = modelled.list$time 

model.plot.modelled = 
  ggplot(modelled.list) +
  geom_line(aes(x=time,y=value,col=cluster)) +
  scale_y_continuous(name=y.axis.label) + 
  scale_x_continuous(name=x.axis.label) +
  ggtitle(plot.title) +
  scale_color_manual(lab=paste("Group ",members.per.cluster$Var1," (n=",members.per.cluster$Freq,")",sep=""),
                          values=c(2,3,4),
                          name="Estimated group trajectories") +
       theme_minimal()
     model.plot.modelled
  