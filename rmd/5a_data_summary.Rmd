---
title: "Data"
author: "Brit Henderson"
date: "Last Updated: `r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r directories, echo=FALSE, include=FALSE}
readdatdir <- "/data/share/xproject/Training/Practice/henderson/Dissertation/rda"
rdadir <- "/data/share/xproject/Training/Practice/henderson/Dissertation/rda"

```

```{r functions, include=FALSE}

```

```{r packages, include=FALSE}
# # Import packages
library(Hmisc)
library(tidyverse) # suite of packages in for manipulating/tidying/visualizing, etc. data
library(lubridate) # manipulating dates
library(readxl)  # read in excel files
library(knitr) # for RMD formatting
library(kableExtra) # to output tables as images
library(fastDummies) # easy creation of dummy variables 



```


#Descriptive Statistics
Sources and variables
Data for this analysis data from two main sources: the Uniform Crime Reporting (UCR) Program and the U.S. Census Bureau. To create arrest rates among young adults and older adults, I use the Federal Bureau of Investigation’s Uniform Crime Reporting Program Data. I will be using the data on aggregated Arrests by Age, Race and Sex (often referred to as ASR) accessed through the Inter-university Consortium for Political and Social Research’s (ICPSR) openICPSR online self-publishing data repository. Specifically, I use the data sets created by Jacob Kaplan. These data, which are reported by law enforcement agencies (e.g. city, county, state, and tribal law police departments and sheriff’s offices) include annual agency-level information on the number of arrests reported for various types of crimes from 1974 through 2019. This time period allows me to examine arrest rates both before and after the growth in literature around emerging adulthood and developments in neuroscience. It also includes economic recessionary periods which will likely have varying effects on arrest rates across counties (Bushway, Cook, and Phillips, 2013; Lauritsen and Heimer, 2010; Rosenfeld, 2009). 

It is important to note that the data does not include detailed age by race information but only broad age-groups (juvenile vs adult) by race (e.g. white juveniles, Asian adults). The Uniform Crime Report data do not track individuals over time; a person who is arrested multiple times by the same agency in the same year will be counted multiple times. Furthermore, information on arrest charges captures the most serious offense for the arrest event. So if an individual is charged with robbery and loitering at the same arrest, the robbery charge will be recorded as the arrest charge type because it represents the most serious offense. The data also include county and state FIPS codes which will be used to link to county-level Census data, agency name and id number which together uniquely identify each reporting agency in the U.S., and the number of months each agency reported data which will be used to assess the extent of missing data. 

The UCR data are not without limitations which have been documented by Jacob Kaplan (2021) in his user manual and by Maltz and Targonski (2002) and Maltz and Weiss (2006). One of the main issues is the voluntary nature of data reporting. This means that some agencies may not be included in this data, resulting in undercounting when aggregating agency-level data up to the county level. Furthermore, there may be underreporting in general, though the FBI performs a number of checks to assess data validity. To address this limitation, I will flag counties that are likely missing data for a given year and include sensitivity tests with imputed values for these missing observations and also with these counties excluded (see appendix Table 1 for a list of proposed sensitivity tests). Also to my advantage, the group-based trajectory modelling is able to accommodate missing data. Because I will be aggregating agencies up to the county level, I will not be able to account for agencies that may span multiple counties. Therefore, I will also include  sensitivity analyses that exclude agencies that are not within a specified distance to another agency and that are close to a county boundary. Importantly, because the ultimate goal of these analyses (i.e. assessing long term patterns in young adult arrest rates as opposed to estimating arrest rate levels or causal effects), the results and conclusions should not be substantially impacted by imprecision at the county-level. In terms of the county-level time-varying predictors and covariates, all variables may not be available for all years, though I should be able to capture enough time points to provide information on how shifts in these factors affect arrest rates.

The raw data are observed at the agency-level. 

#Graph of number of agencies reporting over time
```{r, echo=FALSE}
dat1 <- readRDS(here::here("rda/arrests_by_agency.rds")) 
dat2 <- dat1 %>% 
  group_by(year) %>% summarise(n = n())


ggplot(data = dat2 , mapping = aes(y=n, x=as.factor(year))) +  
  geom_point(color="blue", 
             size = 2) +
  geom_segment(aes(x = as.factor(year), 
               xend = as.factor(year), 
               y = 0,
               yend =n), color="lightgrey") +
               #y = reorder(country, lifeExp), 
              # yend = reorder(country, lifeExp)),
              
  labs (x = "Year",
        y = "",
        title = "Number of Agencies Reporting by Year",
        subtitle = "UCR Arrests by Age Data") +
  theme_minimal() + theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

```


#Graph of number of counties included over time, red = number of counties with non-zero values
```{r, echo=FALSE}
ccount1 <- readRDS(here::here("rda/total_arrests_by_county.rds")) 
ccount2 <- ccount1 %>% 
  group_by(year) %>% 
  summarise( n = n())

ccount3 <- ccount1 %>%
  filter(c_all_adult_tot >0) %>% 
  group_by(year) %>% 
  summarise( n = n())


ggplot(data = ccount2 , mapping = aes(y=n, x=as.factor(year))) +  
  geom_point(color="blue", 
             size = 2) +
  geom_segment(aes(x = as.factor(year), 
               xend = as.factor(year), 
               y = 2400,
               yend =n), color="lightgrey") +
               #y = reorder(country, lifeExp), 
              # yend = reorder(country, lifeExp)),
  geom_point(data=ccount3, aes(x = as.factor(year)),
             color="red", 
             size = 2) +
  geom_segment(data=ccount3, aes(x = as.factor(year), 
               xend = as.factor(year), 
               y = 2400,
               yend =n), color="lightgrey") +
  labs (x = "Year",
        y = "",
        title = "Number of Counties Reporting by Year",
        subtitle = "UCR Arrests by Age Data") +
  theme_minimal() + theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

```


#Graph number of agencies per county average, min, max, over time
```{r}
acount <- dat1 %>% 
  filter(year >= 1974 & fips_state_county_code != "0") %>% 
  group_by(fips_state_county_code,year) %>% 
  summarise(number.agencies = n())

#%>% 
#  group_by(year) %>% 
#  summarise(average = mean(number.agencies),
#            lower = quantile(number.agencies,probs = c(.25)),
#            upper = quantile(number.agencies,probs = c(.75)))


ggplot(data=acount) +
 geom_boxplot(aes(x = as.factor(year), y = number.agencies),outlier.alpha = .01) +  #, outlier.shape = NA)
  scale_y_continuous(limits   = c(0,10), breaks = seq(0,10,1)) #+
    #geom_errorbar(aes(ymin = number.agencies - se, ymax = number.agencies + se), width = .1)

ggplot(data=acount) +
  geom_histogram(aes(x=number.agencies), binwidth = 1) +
  scale_x_continuous(limits = c(0,50))#+
  

```

#Graph number of agencies that report for all 46 years
```{r}

ayears <- dat1 %>% 
  filter( ori9 !="0") %>% 
  group_by(ori9) %>% 
  summarise(years_included = n())

n_distinct(ayears$ori9)

extrayears <- as.list(filter(ayears, years_included > 46) %>% select(ori9))
# confirming that this problem has been corrected

janitor::tabyl(ayears,years_included)

ggplot() +
  geom_histogram(data = ayears, aes(x=years_included), bins = 46)

```
There are `r n_distinct(ayears$ori9` distinct agencies included in the data. However, some agencies close over time while new agencies may open.


U.S. Census Bureau Data

I will use county-level Census Bureau data to create independent variables representing county-level demographic markers of the transition to adulthood and opportunity structures. I will draw from several Census Bureau data products (e.g. Decennial Census, American Community Survey) and data tables. I will also use Census Bureau TIGER shapefiles for mapping purposes. The data files include information necessary for linkage to county-level arrest data. 

#Graph of number of counties included over time


```{r}
pop1 <- readRDS(here::here("rda/population_wide.rds")) 
pop2 <- pop1 %>% 
  filter(is.na(year)==0) %>% 
  group_by(year) %>% summarise(n = n())


ggplot(data = pop2 , mapping = aes(y=n, x=as.factor(year))) +  
  geom_point(color="blue", 
             size = 2) +
  geom_segment(aes(x = as.factor(year), 
               xend = as.factor(year), 
               y = 3000,
               yend =n), color="lightgrey") +
               #y = reorder(country, lifeExp), 
              # yend = reorder(country, lifeExp)),
              
  labs (x = "Year",
        y = "",
        title = "Number of Counties in U.S. by Year",
        subtitle = "Census Population Estimates by Age Data") +
  theme_minimal() + theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())
  
  
```


Dependent variable: The key outcome variable is aggregate county-level rates of arrests per 100,000 residents in the population ages 18 to 24. For each county-year, I create this variable by summing the number of young adult arrests across all agencies within a given county for a given year and then divide this number by the number of young adults in the general population of the county for that year and multiply the resulting value by 100,000. Because it is also helpful to understand the young adult arrest rate in comparison to overall arrest rates, I include a supplemental dependent variable that captures the ratio of the young adult arrest rate to the overall arrest rate.  For this second measure, I divide the young adult arrest rate by the total arrest rate for all residents of a county to understand how rates of arrests among young adults shift in relation to overall rates of arrest. This captures whether any observed trends are specific to young adults or are a reflection of dynamics among all groups.  While all of the analyses focus on the first primary measure - young adult arrest rates - I include supplemental versions that repeat each analysis for the second “ratio” variable.


```{r merge}
combo1 <- readRDS(here::here("rda/combined_populations_arrests.rds")) 


# Checking merge
janitor::tabyl(combo1,inarrest, inpop)
##143,218 records in both data sets




## 16,068 records only in population data
# Checking records in pop data but not arrest data
filter(combo1, inpop==1 & inarrest==0) %>% 
  select(year) %>% 
  janitor::tabyl(year)
### as expected, most (15,490) of the records which appear only in population data are precede the start (1974) of the arrest data.
### but there are 578 records that occur in later years
#### 238 are for counties in AK (fips state code = 02)
#### 12 for counties in NY (fips state code = 36)
##### 92 have VA counties (fips state code = 51)
##### 112 for CO counties (fips state code = 08)
##### 8 for NM counties (fips state code = 35)
##### 46 for HI counties (fips state code = 15)
##### 20 for MO counites (fips state code = 02)
##### 20 for AZ counites (fips state code = 04)
###missing info for 30 of these


checkdat1 <- filter(combo1, inpop==1 & inarrest==0 & year > 1973) 
janitor::tabyl(checkdat1$Name)
janitor::tabyl(checkdat1$year)
janitor::tabyl(checkdat1,fips_clean,State, useNA="always")
janitor::tabyl(checkdat1$State)
table(checkdat1$fips_clean, useNA="always")


# Checking records in arrest data but not pop data
## 2,162 records only in arrest data
checkdat2 <- filter(combo1, inpop==0 & inarrest==1) 
janitor::tabyl(checkdat2$state)
janitor::tabyl(checkdat2$year)
janitor::tabyl(checkdat2,fips_clean,State, useNA="always")
janitor::tabyl(checkdat2$State)
table(checkdat1$fips_clean, useNA="always")

### 413 (19.1%) in alaska
### 278 (12.8%) in virginia
### 161 (7.4%) in colorado
### 121 (5.6%) in hawaii
### all other states make up about 1-2% of these non-matching records

summary(combo1)
describe(combo1)
glimpse(combo1)
```

143,218 records in both data sets

#Graph (or map) of counties never included in arrest data

```{r}
dat3 <- readRDS(here::here("rda/trajectory_pre_analysis_file.rds")) 
dat4 <- dat3 %>% filter(year >=1974 & inpop != inarrest)
dat5 <- dat3 %>% 
  filter(year >= 1974) %>% 
  mutate(missing = inpop - inarrest,
         extra = inarrest - inpop) %>% 
  group_by(year) %>% 
  summarise( Reporting = sum(inarrest),
             Non_reporting = sum(inpop),
             Missing = sum(missing),
             Extra = sum(extra))

```


16,068 records only in population data
as expected, most (15,490) of the records which appear only in population data are precede the start (1974) of the arrest data.
but there are 578 records that occur in later years
238 are for counties in AK (fips state code = 02)
12 for counties in NY (fips state code = 36)
92 have VA counties (fips state code = 51)
112 for CO counties (fips state code = 08)
8 for NM counties (fips state code = 35)
46 for HI counties (fips state code = 15)
20 for MO counites (fips state code = 02)
20 for AZ counites (fips state code = 04)
missing info for 30 of these

2,162 records only in arrest data
413 (19.1%) in alaska
278 (12.8%) in virginia
161 (7.4%) in colorado
121 (5.6%) in hawaii
all other states make up about 1-2% of these non-matching records

#List of counties that are missing from recent years (2017-2019, noticeable drop)






#Graph of young adult arrest rates over time (county-level mean)


```{r}
checkrates <- readRDS(here::here("rda/trajectory_analysis_file.rds")) 
checkrates2 <- checkrates %>% 
  group_by(year) %>% 
  summarise(mean = mean(young_adult_rate, na.rm = TRUE),
             upper = mean + (sd(young_adult_rate, na.rm = TRUE)), #/sqrt(length(young_adult_rate),na.rm = TRUE)),
              lower = mean - (sd(young_adult_rate, na.rm = TRUE))) #/sqrt(length(young_adult_rate),na.rm = TRUE)))

checkrates3 <-filter(checkrates, year==2013)
checkrates4 <- filter(checkrates, young_adult_rate >  )

ggplot() +
  geom_histogram(data=checkrates, aes(x=young_adult_rate)) + scale_x_continuous(limits = c(0,1000))

ggplot(data=checkrates) +
  geom_errorbar(data=checkrates2, mapping=aes(x=year, ymin=lower, ymax=upper), width=0.2, size=1, color="blue") +
  geom_point(data=checkrates2, mapping=aes(x=year, y=mean), size=4,shape=21, fill="white") +
  labs (x = "Year",
        y = "",
        title = "Average Young Adult Arrest Rate by Year",
        subtitle = "Arrest per 1,000 Young Adults Ages 18 to 24") 


```


#Graph of young adult arrest rates over time (all counties, mean highlighted, 25th and 75th percentiles)


```{r}
# load data
summarydat1 <- readRDS(here::here("/data/share/xproject/training/practice/henderson/dissertation/rda/trajectory_analysis_file.rds"))


# remove duplicates
summarydat2 <- filter(summarydat1,fips_clean != "0")

# Create a national arrest rate data set
nationaldat <- summarydat2 %>% group_by(year) %>%  summarise(total.arrests = sum(c_young_adult_tot), 
                                          total.pop = sum(n_young_adults, na.rm=TRUE),
                                          total.rate = total.arrests/total.pop * 1000,
                                          avg.rate = mean(young_adult_rate, na.rm = TRUE),
                                          lower = avg.rate - (sd(young_adult_rate, na.rm = TRUE)/sqrt(3142)),
                                          upper = avg.rate + (sd(young_adult_rate, na.rm = TRUE)/sqrt(3142)))


ggplot(nationaldat, aes(x=year)) +
  geom_line(aes(y=avg.rate, color = "Average County Rate")) +
  geom_line(aes(y=total.rate, color = "National Rate")) + 
  geom_line(aes(y=lower), col = "lightblue") +
  geom_line(aes(y=upper), col = "lightblue") +
  scale_y_continuous(limits = c(0,200)) +
  scale_x_continuous(limits = c(1974,2019)) +
  scale_color_manual(name="",
                      breaks = c("Average County Rate","National Rate"),
                      values = c("Average County Rate" = "blue", "National Rate" = "black"))



ggplot(nationaldat, aes(x=year)) +
  geom_smooth(aes(y=total.rate), col = "black", lty=2) + 
  scale_y_continuous(limits = c(0,200)) +
  scale_x_continuous(limits = c(1974,2019))  +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())


```


#Graph of disparity (mean)



```{r}

```
