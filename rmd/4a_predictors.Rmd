---
title: "4a_predictors"
author: "Brit C. Henderson"
date: '2022-07-08'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = FALSE)
```


# Open Intro County Complete Data Set
Source:https://www.ers.usda.gov/data-products/county-level-data-sets/download-data/  

Then: https://www.openintro.org/data/?data=county_complete
The data prior to 2011 was from http://census.gov, though the exact page it came from is no longer available.

More recent data comes from the following sources.

*Downloaded via the tidycensus R package.
*Download links for spreadsheets were found on https://www.ers.usda.gov/data-products/county-level-data-sets/download-data
*Unemployment - Bureau of Labor Statistics - LAUS data - https://www.bls.gov/lau/.
*Median Household Income - Census Bureau - Small Area Income and Poverty Estimates (SAIPE) data.
*The original data table was prepared by USDA, Economic Research Service.
*Census Bureau.
*2012-16 American Community Survey 5-yr average.
*The original data table was prepared by USDA, Economic Research Service.
*Tim Parker (tparker at ers.usda.gov) is the contact for much of the new data incorporated into this data set.
```{r include=FALSE}
library(tidyverse)
#Read in data and pick 6 to 10 factors
dat <- read_csv(here::here("raw/CountyPredictors", "county_complete.csv"))
dat2 <- dat %>% 
  select(fips, state, name, pop2017, some_college_2017, hs_grad_2017, broadband_2017, median_household_income_2017, poverty_2017, unemployment_rate_2017   ) %>% 
  mutate(fips_clean = as.character(sprintf("%05d", fips)))

```

# County Business Patterns Data: 2019
https://www.census.gov/data/datasets/2019/econ/cbp/2019-cbp.html
technical documentation: https://www.census.gov/programs-surveys/cbp/technical-documentation/methodology.html

Reading in data and selecting naics codes corresponding to commercial banks, savings institutions, and credit unions
```{r}

dat.cbp2019 <- read_csv(here::here("raw/CountyPredictors", "cbp19co.txt"))
dat2.cbp2019 <- dat.cbp2019 %>% 
  filter(naics %in% c("522110","522120" ,"522130")) %>% 
  select( fipstate, fipscty, est) %>% 
  mutate(fips_clean = paste(fipstate, fipscty, sep = "")) %>% 
  group_by(fips_clean) %>% 
  summarise(nbanks = sum(est))

```

# County Income Inequaltiy
https://www.countyhealthrankings.org/app/colorado/2017/measure/factors/44/datasource

NOTE: May have to download separate data set for each state...

#Merge County predictors with other county-level file
```{r}
# reading in geo file
analysis.geo1 <- as.data.frame(readRDS(here::here("rda","analysis.geo.rds")))

#put all data frames into list
#df_list <- list(analysis.geo1, dat2, dat2.cbp2019)
#<- df_list %>% reduce(full_join, by='fips_clean')

merge1 <- merge(analysis.geo1, dat2, by = "fips_clean", all = TRUE)

#merge all data frames in list
analysis.dat.combo <- merge(merge1, dat2.cbp2019, by = "fips_clean", all = TRUE)


```

# Checking for missing data
```{r}
summary(analysis.dat.combo)
visdat::vis_dat(analysis.dat.combo)
visdat::vis_miss(analysis.dat.combo)
100 * (apply(apply(analysis.dat.combo, 2, is.na), 2, sum)/nrow(analysis.dat.combo))

check.miss <-filter(analysis.dat.combo, is.na(nbanks)==1)
as.data.frame(table(check.miss$state_abb, useNA = "always"))


dat_na_rm <- na.omit(dat)
100 * (nrow(dat_na_rm)/nrow(dat))
```

For demonstration purposes, we omit all the missing observations from the data.

```{r}
dat <- na.omit(dat)
```


# Decide how to discretize continuous variables
```{r}
analysis.dat.combo2 <- analysis.dat.combo %>% 
  mutate(bankrate = nbanks/pop2017,
         
         bankrate.na = as.numeric(is.na(bankrate)),
         bankrate.ltp25 = ifelse(as.numeric(is.na(bankrate)) == 1,0, ifelse(
           bankrate < quantile(bankrate, .25, na.rm = TRUE),1,0)),
         bankrate.gtp75 = ifelse(is.na(bankrate) == 0, bankrate > quantile(bankrate, .75, na.rm = TRUE),0),
         bankrate.p25top75 = ifelse(is.na(bankrate) == 0, bankrate <= quantile(bankrate, .75, na.rm = TRUE) 
                                    & bankrate >= quantile(bankrate,.25, na.rm = TRUE),0),
         
         poverty_2017.ltp25 = poverty_2017 < quantile(poverty_2017, .25, na.rm = TRUE),
         poverty_2017.gtp75 = poverty_2017 > quantile(poverty_2017,.75, na.rm = TRUE),
         poverty_2017.p25top75 = poverty_2017 <= quantile(poverty_2017, .75, na.rm = TRUE) 
         & poverty_2017 >= quantile(poverty_2017,.25, na.rm = TRUE),
         
         unemployment_rate_2017.ltp25 = unemployment_rate_2017 < quantile(unemployment_rate_2017, .25, na.rm = TRUE),
         unemployment_rate_2017.gtp75 = unemployment_rate_2017 > quantile(unemployment_rate_2017, .75, na.rm = TRUE),
         unemployment_rate_2017.p25top75 =  unemployment_rate_2017 <= quantile( unemployment_rate_2017, .75, na.rm = TRUE) 
         &  unemployment_rate_2017 >= quantile( unemployment_rate_2017,.25, na.rm = TRUE),
         
         median_household_income_2017.ltp25 = median_household_income_2017 < quantile(median_household_income_2017, .25, na.rm = TRUE),
         median_household_income_2017.gtp75 = median_household_income_2017 > quantile(median_household_income_2017, .75, na.rm = TRUE),
         median_household_income_2017.p25top75 = median_household_income_2017 <= quantile(median_household_income_2017, .75, na.rm = TRUE) 
         & median_household_income_2017 >= quantile(median_household_income_2017,.25, na.rm = TRUE),

         some_college_2017.ltp25 = some_college_2017 < quantile(some_college_2017, .25, na.rm = TRUE),
         some_college_2017.gtp75 = some_college_2017 > quantile(some_college_2017, .75, na.rm = TRUE),
         some_college_2017.p25top75 = some_college_2017 <= quantile(some_college_2017, .75, na.rm = TRUE) 
         & some_college_2017 >= quantile(some_college_2017,.25, na.rm = TRUE),

         hs_grad_2017.ltp25 = hs_grad_2017 < quantile(hs_grad_2017, .25, na.rm = TRUE),
         hs_grad_2017.gtp75 = hs_grad_2017 > quantile(hs_grad_2017, .75, na.rm = TRUE),
         hs_grad_2017.p25top75 = hs_grad_2017 <= quantile(hs_grad_2017, .75, na.rm = TRUE) 
         & hs_grad_2017 >= quantile(hs_grad_2017,.25, na.rm = TRUE),
         
         broadband_2017.ltp25 = broadband_2017 < quantile(broadband_2017, .25, na.rm = TRUE),
         broadband_2017.gtp75 = broadband_2017 > quantile(broadband_2017, .75, na.rm = TRUE),
         broadband_2017.p25top75 = broadband_2017 <= quantile(broadband_2017, .75, na.rm = TRUE) 
         & broadband_2017 >= quantile(broadband_2017,.25, na.rm = TRUE))
         

```



# Save final variable importance analysis file
```{r}
analysis.vi <- analysis.dat.combo2
saveRDS(analysis.vi, here::here("rda","analysis.vi.rds"))
```

