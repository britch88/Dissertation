---
title: "3b_elsa"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r directories}
readdatdir <- "/data/share/xproject/Training/Practice/henderson/Dissertation/rda"
rdadir <- "/data/share/xproject/Training/Practice/henderson/Dissertation/rda"

```

# packages
```{r include=FALSE, results='hide'}

library(tidyverse)
library(Hmisc)
library(GGally)
library(cowplot)
library(reshape2)
library(tigris)
library(spdep)
library(spatialreg)
library(sf)
library(rgdal)
library(spdplyr)
library(stringr)
library(gstat)
library(elsa)
library(GISTools)

```

#Save this crucial SpatialPolygonDataFrame - no idea how I created it
```{r include=FALSE}
data(tornados)
writeOGR(obj=torn, dsn="rdadir", layer="tornx", driver="ESRI Shapefile") # this is in geographical projection

writeOGR(obj=torn2, dsn="tempdir", layer="torn2", driver="ESRI Shapefile") # this is in equal area projection

drop <- c("ALAND","AWATER")
analysis.dat2x = analysis.dat2[,!(names(analysis.dat2) %in% drop)]

writeOGR(obj=analysis.dat2x, dsn="rdadir", layer="maindat", driver="ESRI Shapefile") # this is in geographical projection

writeOGR(obj=torn2, dsn="tempdir", layer="torn2", driver="ESRI Shapefile") # this is in equal area projection


```


# Source Functions
```{r}
knitr::purl("rmd/0a_functions.Rmd")
source("rmd/0a_functions.R")
```

#Overview of ELSA
## from https://cran.r-project.org/web/packages/elsa/vignettes/elsa.html
ELSA (entropy-based local indicator of spatial association) is a novel spatial statistic to measure local spatial autocorrelation in both categorical and continuous spatial data. ELSA quantifies the degree of spatial association of a variable at each location relative to its neighbouring locations. This indicator simultaneously incorporates both spatial and attribute aspects of spatial association into account for both categorical and continuous data. The values of ELSA vary between 0 and 1, which denote highest and lowest spatial association, respectively.

In addition, entrogram is also developed based on ELSA that is a novel approach for exploring the global spatial structure within the entire area (like a variogram). The entrogram uses ELSA to characterize the spatial association and can be used for both continuous and binary or multi-class categorical data.

To find out more details about these new methods, look at the following paper published in the journal of Spatial Statistics:

Naimi, B., Hamm, N. A., Groen, T. A., Skidmore, A. K., Toxopeus, A. G., & Alibakhshi, S. (2019). ELSA: Entropy-based local indicator of spatial association. Spatial statistics, 29, 66-88.

```{r}
#Practice
file <- system.file('external/lc_example.grd',package='elsa') 
lc <- raster(file)
plot(lc,main='Land cover: a categorical map')
elc <- elsa(lc, d=2000,categorical = T)
cl <- colorRampPalette(c('darkblue','yellow','red','black'))(100) # specifying a color scheme
plot(elc, col=cl, main='ELSA')


cl2 <- colorRampPalette(c('darkblue','white'))(12) # specifying a color scheme


#Okay, the above is a fail - going to try rasterizing the data
load("/data/share/xproject/Training/Practice/henderson/Dissertation/ws220603.RData")
rm(analysis.df,analysis.dat,analysis.df2,checkmerge,coords,countydat,divisions.df, divisions.df2, group.proportions,kn6,
   queen, regions.df, regions.df2, regions.dfv2, shapefile, shapefile2,states.df, states.df2, traj.results,traj.results2,use.data,
   wrld_simpl, f1, id, nbdata, long_traj,occ,pred_means, pred_means_Nt,weighted_means)


r <- raster(ncol=180, nrow=180)
extent(r) <- extent(analysis.dat2)
analysis.dat2$group2 <- as.factor(analysis.dat2$group)

drop <- c("ALAND","AWATER","state","Grp1","Grp2","Grp3","Grp4","Grp5","Grp6","Name","LSAD","CLASSFP","MTFCC","CSAFP","CBSAFP","METDIVFP","in.s","in.t","STATEFP","COUNTYFP","COUNTYNS","fips_clean", "country_division")
#analysis.dat2x = analysis.dat2[,!(names(analysis.dat2) %in% drop)]
analysis.dat3 = analysis.dat2[,!(names(analysis.dat2) %in% drop)]
rm(analysis.dat2)

rp <- rasterize(analysis.dat3, r, 'group2')
plot(rp)


#start here
load("/data/share/xproject/Training/Practice/henderson/Dissertation/ws220610_elsa.RData")
attempt5 <- elsa(rp, d=2000,categorical = T)
cl <- colorRampPalette(c('darkblue','yellow','red','black'))(100) # specifying a color scheme
plot(elc, col=cl, main='ELSA')


```

